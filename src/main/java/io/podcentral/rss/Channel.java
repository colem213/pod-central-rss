package io.podcentral.rss;

import java.net.MalformedURLException;
import java.net.URI;
import java.net.URISyntaxException;
import java.time.Instant;
import java.util.List;

import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.adapters.XmlJavaTypeAdapter;

import org.eclipse.persistence.oxm.annotations.XmlPath;

import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBAttribute;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBAutoGeneratedKey;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBHashKey;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBIgnore;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBIndexHashKey;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBTable;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBTypeConverted;

import io.podcentral.aws.InstantConverter;
import io.podcentral.aws.UriConverter;
import io.podcentral.config.TableConstants;
import io.podcentral.feed.exception.InvalidFeedUrlException;
import io.podcentral.xml.ItunesExplicitAdapter;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.NonNull;
import lombok.RequiredArgsConstructor;

@NoArgsConstructor
@RequiredArgsConstructor
@DynamoDBTable(tableName = TableConstants.Feed.TABLE_NAME)
@Data
public class Channel {
  @NonNull
  @DynamoDBHashKey
  @DynamoDBAutoGeneratedKey
  private String id;
  private String title;
  @DynamoDBIgnore
  @XmlElement(name = "description")
  private String rssDescription;
  private String link;
  @DynamoDBTypeConverted(converter = InstantConverter.class)
  private Instant pubDate;
  @DynamoDBTypeConverted(converter = InstantConverter.class)
  private Instant lastBuildDate;
  private String language;
  private String copyright;
  private Integer ttl;
  @DynamoDBIgnore
  @XmlPath("image/url/text()")
  private String rssImageUrl;
  @DynamoDBAttribute(attributeName = "imageTitle")
  @XmlPath("image/title/text()")
  private String rssImageTitle;
  @DynamoDBAttribute(attributeName = "imageLink")
  @XmlPath("image/link/text()")
  private String rssImageLink;
  @DynamoDBIgnore
  @XmlElement(name = "category")
  private String rssCategory;
  @DynamoDBAttribute(attributeName = "author")
  @XmlPath("itunes:author/text()")
  private String itunesAuthor;
  @DynamoDBAttribute(attributeName = "block")
  @XmlPath("itunes:block/text()")
  private Boolean itunesBlock;
  @DynamoDBIgnore
  @XmlPath("itunes:image/@href")
  private String itunesImageUrl;
  @DynamoDBIgnore
  @XmlPath("itunes:category[1]")
  private ItunesCategory itunesCategory;
  @DynamoDBAttribute(attributeName = "explicit")
  @XmlJavaTypeAdapter(ItunesExplicitAdapter.class)
  @XmlElement(name = "explicit", namespace = XmlNs.ITUNES)
  private Boolean itunesExplicit;
  @DynamoDBAttribute(attributeName = "complete")
  @XmlElement(name = "complete", namespace = XmlNs.ITUNES)
  private Boolean itunesIsComplete;
  @DynamoDBAttribute(attributeName = "ownerEmail")
  @XmlPath("itunes:owner/itunes:email/text()")
  private String itunesOwnerEmail;
  @DynamoDBAttribute(attributeName = "ownerName")
  @XmlPath("itunes:owner/itunes:name/text()")
  private String itunesOwnerName;
  @DynamoDBAttribute(attributeName = "subtitle")
  @XmlElement(name = "subtitle", namespace = XmlNs.ITUNES)
  private String itunesSubtitle;
  @DynamoDBIgnore
  @XmlElement(name = "summary", namespace = XmlNs.ITUNES)
  private String itunesSummary;

  @NonNull
  @DynamoDBIndexHashKey(globalSecondaryIndexName = TableConstants.Feed.GSI_URI_INDEX)
  @DynamoDBTypeConverted(converter = UriConverter.class)
  private URI feedUrl;

  @DynamoDBIgnore
  @XmlElement(name = "item")
  private List<Item> entries;

  @DynamoDBAttribute(attributeName = "imageUrl")
  public String getImageUrl() {
    return itunesImageUrl != null ? itunesImageUrl : rssImageUrl;
  }

  @DynamoDBAttribute(attributeName = "description")
  public String getDescription() {
    return itunesSummary != null ? itunesSummary : rssDescription;
  }

  @DynamoDBAttribute(attributeName = "categories")
  public ItunesCategory getCategories() {
    return itunesCategory != null ? itunesCategory : new ItunesCategory(rssCategory);
  }

  public Channel(String id, String feedUrl) {
    setId(id);
    setFeedUrl(feedUrl);
  }

  public void setFeedUrl(String feedUrl) {
    try {
      setFeedUrl(new URI(feedUrl));
    } catch (URISyntaxException e) {
      throw new InvalidFeedUrlException(feedUrl);
    }
  }

  public void setFeedUrl(URI uri) {
    if (uri.isOpaque()) {
      throw new IllegalArgumentException("URL must be server-based!");
    }
    try {
      uri = uri.normalize();
      int defaultPort = uri.toURL().getDefaultPort();
      int port = uri.getPort() == -1 || uri.getPort() == defaultPort ? -1 : uri.getPort();
      this.feedUrl = new URI(uri.getScheme(), null, uri.getHost(), port, uri.getPath(), null, null);
    } catch (MalformedURLException | URISyntaxException e) {
      throw new InvalidFeedUrlException(uri.toString());
    }
  }
}
